[{"name": "cleanup-expired", "description": "This app cleans up resources that have expired.", "version": "1.0.0", "language": "jinja2", "license": "Apache 2.0", "authors": ["someengineering"], "url": "https://resoto.com/", "categories": ["cleanup"], "default_config": null, "config_schema": null, "args_schema": null, "readme": "# cleanup-expired\nResoto app for cleanup of expired resources\n\nThis app looks for resources with the tags `expiration` or `resoto:expires` and flags them for cleanup if they are expired.\n\n## Tag format\n\n| Tag              | Format                      | Description                                          |\n| ---------------- | --------------------------- | ---------------------------------------------------- |\n| `resoto:expires` | `2019-09-05T10:40:11+00:00` | ISO 8601 Timestamp                                   |\n| `expiration`     | `24h`                       | A timedelta relative to the resource's creation time |\n\nExample of valid units for the `expiration` tag:\n\n```\nweeks\ndays\nhours\nminutes\n```\n\nEach of them can be abbreviated down to one letter. E.g. `7d`, `24h`, `60m`, etc. A space in between the numeric and the unit is optional, meaning `7d` and `7 days` are equivalent.\n", "icon": "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGNsYXNzPSJpY29uIGljb24tdGFibGVyIGljb24tdGFibGVyLWJhdCIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlPSJjdXJyZW50Q29sb3IiIGZpbGw9Im5vbmUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+CiAgPHBhdGggc3Ryb2tlPSJub25lIiBkPSJNMCAwaDI0djI0SDB6IiBmaWxsPSJub25lIi8+CiAgPHBhdGggZD0iTTE3IDE2Yy43NCAtMi4yODYgMi43NzggLTMuNzYyIDUgLTNjLS4xNzMgLTIuNTk1IC4xMyAtNS4zMTQgLTIgLTcuNWMtMS43MDggMi42NDggLTMuMzU4IDIuNTU3IC01IDIuNXYtNGwtMyAybC0zIC0ydjRjLTEuNjQyIC4wNTcgLTMuMjkyIC4xNDggLTUgLTIuNWMtMi4xMyAyLjE4NiAtMS44MjcgNC45MDUgLTIgNy41YzIuMjIyIC0uNzYyIDQuMjYgLjcxNCA1IDNjMi41OTMgMCAzLjg4OSAuOTUyIDUgNGMxLjExMSAtMy4wNDggMi40MDcgLTQgNSAtNHoiIC8+CiAgPHBhdGggZD0iTTkgOGEzIDMgMCAwIDAgNiAwIiAvPgo8L3N2Zz4KCgo=", "source_hash": "sha256:bac8e79e6c972552102f0cfa35362a806729203a7e62b8dfc3d6c4b9d6755996", "source": "search /metadata.expires < \"@NOW@\" | clean \"Resource is expired\"\n"}, {"name": "cleanup-volumes", "description": "This app cleans up unused storage volumes that have reached a certain age threshold.", "version": "1.0.0", "language": "jinja2", "license": "Apache 2.0", "authors": ["someengineering"], "url": "https://resoto.com/", "categories": ["cleanup"], "default_config": null, "config_schema": [{"fqn": "cleanup_volumes", "bases": [], "properties": [{"name": "min_age", "kind": "string", "required": true, "description": "Minimum age of unused volumes to cleanup."}]}], "args_schema": null, "readme": "# cleanup-volumes\nVolume cleanup app for Resoto\n\nThis app cleans up unused storage volumes that have reached a certain age threshold.\n\n## Usage\n\n```\ncleanup_volumes:\n  # Minimum age of unused volumes to cleanup\n  min_age: 14d\n```\n\nThe default volume age is 14 days. Meaning if a volume is not in use and has not had any read or write IOPS within the last 14 days it will be deleted.\n\nOptionally change the age cutoff value using the `min_age` option.\n\nExample of valid age units:\n\n```\nweeks\ndays\nhours\nminutes\n```\n\nEach of them can be abbreviated down to one letter. E.g. `7d`, `24h`, `60m`, etc. A space in between the numeric and the unit is optional, meaning `7d` and `7 days` are equivalent.\n", "icon": "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGNsYXNzPSJpY29uIGljb24tdGFibGVyIGljb24tdGFibGVyLWJhdCIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlPSJjdXJyZW50Q29sb3IiIGZpbGw9Im5vbmUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+CiAgPHBhdGggc3Ryb2tlPSJub25lIiBkPSJNMCAwaDI0djI0SDB6IiBmaWxsPSJub25lIi8+CiAgPHBhdGggZD0iTTE3IDE2Yy43NCAtMi4yODYgMi43NzggLTMuNzYyIDUgLTNjLS4xNzMgLTIuNTk1IC4xMyAtNS4zMTQgLTIgLTcuNWMtMS43MDggMi42NDggLTMuMzU4IDIuNTU3IC01IDIuNXYtNGwtMyAybC0zIC0ydjRjLTEuNjQyIC4wNTcgLTMuMjkyIC4xNDggLTUgLTIuNWMtMi4xMyAyLjE4NiAtMS44MjcgNC45MDUgLTIgNy41YzIuMjIyIC0uNzYyIDQuMjYgLjcxNCA1IDNjMi41OTMgMCAzLjg4OSAuOTUyIDUgNGMxLjExMSAtMy4wNDggMi40MDcgLTQgNSAtNHoiIC8+CiAgPHBhdGggZD0iTTkgOGEzIDMgMCAwIDAgNiAwIiAvPgo8L3N2Zz4KCgo=", "source_hash": "sha256:6a6493a31b1ed02f500664cfb98808b0da924232708c7ed2b6f37fcec7a4edd6", "source": "search is(volume) and volume_status == available and age > {{ config['min_age'] }} and last_access > {{ config['min_age'] }} | clean \"Volume is not in use and had not I/O for more than {{ config['min_age'] }}\"\n"}, {"name": "cleanup-aws-vpcs", "description": "Find VPCs marked for cleanup and marks all dependencies for cleanup as well.", "version": "1.0.0", "language": "jinja2", "license": "Apache 2.0", "authors": ["someengineering"], "url": "https://resoto.com/", "categories": ["cleanup"], "default_config": {"cloud_and_accounts": {"aws": ["1234567", "567890"]}}, "config_schema": [{"fqn": "cleanup_aws_vpcs", "bases": [], "properties": [{"name": "clouds_and_accounts", "kind": "dictionary[string, string[]]", "required": false, "description": "Default age after which tags must exist."}]}], "args_schema": null, "readme": "# cleanup-aws-vpcs\nAWS VPC Cleanup App for Resoto\n\nThis app marks all VPC dependencies for cleanup. The VPC must have been previously marked for cleanup by another cleanup plugin.\n\nThe following resources are currently being marked for cleanup\n\n- AWS VPC Peering Connections\n- AWS EC2 Network ACLs\n- AWS EC2 Network Interfaces\n- AWS ELB\n- AWS ALB\n- AWS ALB Target Groups\n- AWS EC2 Subnets\n- AWS EC2 Security Groups\n- AWS EC2 Internet Gateways\n- AWS EC2 NAT Gateways\n- AWS EC2 Route Tables\n\n## Usage\n\n```\ncleanup_aws_vpcs:\n  # Dictionary of key cloud with list of account IDs for which the plugin should be active as value\n  cloud_and_accounts:\n    aws:\n      - '1234567'\n      - '567890'\n```\n", "icon": "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGNsYXNzPSJpY29uIGljb24tdGFibGVyIGljb24tdGFibGVyLWJhdCIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlPSJjdXJyZW50Q29sb3IiIGZpbGw9Im5vbmUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+CiAgPHBhdGggc3Ryb2tlPSJub25lIiBkPSJNMCAwaDI0djI0SDB6IiBmaWxsPSJub25lIi8+CiAgPHBhdGggZD0iTTE3IDE2Yy43NCAtMi4yODYgMi43NzggLTMuNzYyIDUgLTNjLS4xNzMgLTIuNTk1IC4xMyAtNS4zMTQgLTIgLTcuNWMtMS43MDggMi42NDggLTMuMzU4IDIuNTU3IC01IDIuNXYtNGwtMyAybC0zIC0ydjRjLTEuNjQyIC4wNTcgLTMuMjkyIC4xNDggLTUgLTIuNWMtMi4xMyAyLjE4NiAtMS44MjcgNC45MDUgLTIgNy41YzIuMjIyIC0uNzYyIDQuMjYgLjcxNCA1IDNjMi41OTMgMCAzLjg4OSAuOTUyIDUgNGMxLjExMSAtMy4wNDggMi40MDcgLTQgNSAtNHoiIC8+CiAgPHBhdGggZD0iTTkgOGEzIDMgMCAwIDAgNiAwIiAvPgo8L3N2Zz4KCgo=", "source_hash": "sha256:e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855", "source": ""}, {"name": "protector", "description": "This app protects important resources from deletion by Resoto.", "version": "1.0.0", "language": "jinja2", "license": "Apache 2.0", "authors": ["someengineering"], "url": "https://resoto.com/", "categories": ["protection"], "default_config": {"resources": {"aws": {"110465657741": {"us-east-1": {"aws_ec2_instance": ["i-0fcbe8974615bfd37"]}}, "56789012345": {"us-west-2": {"aws_ec2_volume": ["vol-fcbe8974615b"]}}}}}, "config_schema": [{"fqn": "protector", "bases": [], "properties": [{"name": "resources", "kind": "dictionary[string, dictionary[string, dictionary[string, dictionary[string, string[]]]]]", "required": false, "description": "Resources to protect."}], "allow_unknown_props": false, "successor_kinds": null, "aggregate_root": true, "metadata": null}], "args_schema": null, "readme": "# protector\nProtector App for Resoto\n\nThis app protects important resources from deletion by Resoto.\n\n## Usage\n\n```\nprotector:\n  config:\n    aws:\n      '110465657741':\n        us-east-1:\n          aws_ec2_instance:\n            - 'i-0fcbe8974615bfd37'\n```\n\nThe format of the `config` section is as follows:\n\n```\ncloud.id:\n  account.id:\n    region.id:\n      kind:\n        - resource.id\n```\n\n### Implementation details\n\nEach Resoto resource has an attributed `/metadata.protected` which takes a boolean value. By default it is set to `false`. Each Resoto resource inherits BaseResource which contains two methods for cleaning up a resource, `cleanup()` and `delete()`. Both those methods will refuse to manipulate a resource once the `protected` attribute has been set to `true`. Meaning if a resource is marked as protected but has also been flagged for cleanup the cleanup will fail because protected resources cannot be deleted.\n", "icon": "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGNsYXNzPSJpY29uIGljb24tdGFibGVyIGljb24tdGFibGVyLWJhdCIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlPSJjdXJyZW50Q29sb3IiIGZpbGw9Im5vbmUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+CiAgPHBhdGggc3Ryb2tlPSJub25lIiBkPSJNMCAwaDI0djI0SDB6IiBmaWxsPSJub25lIi8+CiAgPHBhdGggZD0iTTE3IDE2Yy43NCAtMi4yODYgMi43NzggLTMuNzYyIDUgLTNjLS4xNzMgLTIuNTk1IC4xMyAtNS4zMTQgLTIgLTcuNWMtMS43MDggMi42NDggLTMuMzU4IDIuNTU3IC01IDIuNXYtNGwtMyAybC0zIC0ydjRjLTEuNjQyIC4wNTcgLTMuMjkyIC4xNDggLTUgLTIuNWMtMi4xMyAyLjE4NiAtMS44MjcgNC45MDUgLTIgNy41YzIuMjIyIC0uNzYyIDQuMjYgLjcxNCA1IDNjMi41OTMgMCAzLjg4OSAuOTUyIDUgNGMxLjExMSAtMy4wNDggMi40MDcgLTQgNSAtNHoiIC8+CiAgPHBhdGggZD0iTTkgOGEzIDMgMCAwIDAgNiAwIiAvPgo8L3N2Zz4KCgo=", "source_hash": "sha256:c42bbca1a491a98c6a3a7da7ad3dceec773a4aa09a8774d8fa5d8e145edc1065", "source": "{%- for cloud, accounts in config[\"resources\"].items() %}\n    {%- for account, regions in accounts.items() %}\n        {%- for region, kinds in regions.items() %}\n            {%- for kind, resources in kinds.items() %}\n                {%- for resource in resources %}\nsearch is({{ kind }}) and id == \"{{ resource }}\" and /ancestors.region.reported.id == \"{{ region }}\" and /ancestors.account.reported.id == \"{{ account }}\" and /ancestors.cloud.reported.id == \"{{ cloud }}\" | protect\n                {%- endfor %}\n            {%- endfor %}\n        {%- endfor %}\n    {%- endfor %}\n{%- endfor %}\n"}, {"name": "tagvalidator", "description": "Tag Validator app for Resoto.", "version": "1.0.0", "language": "jinja2", "license": "Apache 2.0", "authors": ["someengineering"], "url": "https://resoto.com/", "categories": ["tagging"], "default_config": {"config": {"default": {"expiration": "24h"}, "kinds": ["aws_ec2_instance", "aws_vpc", "aws_cloudformation_stack", "aws_elb", "aws_alb", "aws_alb_target_group", "aws_eks_cluster", "aws_eks_nodegroup", "aws_ec2_nat_gateway"], "accounts": {"aws": {"123465706934": {"name": "eng-audit"}, "123479172032": {"name": "eng-devprod"}, "123453451782": {"name": "sales-lead-gen", "expiration": "12h"}, "123415487488": {"name": "sales-hosted-lead-gen", "expiration": "8d"}}}}}, "config_schema": null, "args_schema": null, "readme": "# tagvalidator\nTag Validator app for Resoto\n\nThis app validates the contents of expiration tags. With it you can enforce a max. expiration length for certain resources in an account. For instance you could have an org policy that says in our \"dev\" account compute instances are only allowed to exist for 2 days max. Then this plugin can ensure that the expiration tag on those instances is set to no more than 2 days. If it is set to e.g. 50h it would be corrected down to 48h.\n\n## Usage\n\n```\ntagvalidator:\n  config:\n    default:\n      expiration: '24h'\n    kinds:\n      - 'aws_ec2_instance'\n      - 'aws_vpc'\n      - 'aws_cloudformation_stack'\n      - 'aws_elb'\n      - 'aws_alb'\n      - 'aws_alb_target_group'\n      - 'aws_eks_cluster'\n      - 'aws_eks_nodegroup'\n      - 'aws_ec2_nat_gateway'\n    accounts:\n      aws:\n        '123465706934':\n          name: 'eng-audit'\n        '123479172032':\n          name: 'eng-devprod'\n        '123453451782':\n          name: 'sales-lead-gen'\n          expiration: '12h'\n        '123415487488':\n          name: 'sales-hosted-lead-gen'\n          expiration: '8d'\n```\n\n## Structure of the config section\n\nThe config contains a default section with the expiration that should be used for all accounts by default. The kinds section contains the list of kinds that these expiration tag rules apply to. The accounts section contain the cloud ids followed by the account ids. Each account id must contain a `name` and optionally an `expiration` that overwrites the global default.\n", "icon": "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGNsYXNzPSJpY29uIGljb24tdGFibGVyIGljb24tdGFibGVyLWJhdCIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlPSJjdXJyZW50Q29sb3IiIGZpbGw9Im5vbmUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+CiAgPHBhdGggc3Ryb2tlPSJub25lIiBkPSJNMCAwaDI0djI0SDB6IiBmaWxsPSJub25lIi8+CiAgPHBhdGggZD0iTTE3IDE2Yy43NCAtMi4yODYgMi43NzggLTMuNzYyIDUgLTNjLS4xNzMgLTIuNTk1IC4xMyAtNS4zMTQgLTIgLTcuNWMtMS43MDggMi42NDggLTMuMzU4IDIuNTU3IC01IDIuNXYtNGwtMyAybC0zIC0ydjRjLTEuNjQyIC4wNTcgLTMuMjkyIC4xNDggLTUgLTIuNWMtMi4xMyAyLjE4NiAtMS44MjcgNC45MDUgLTIgNy41YzIuMjIyIC0uNzYyIDQuMjYgLjcxNCA1IDNjMi41OTMgMCAzLjg4OSAuOTUyIDUgNGMxLjExMSAtMy4wNDggMi40MDcgLTQgNSAtNHoiIC8+CiAgPHBhdGggZD0iTTkgOGEzIDMgMCAwIDAgNiAwIiAvPgo8L3N2Zz4KCgo=", "source_hash": "sha256:e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855", "source": ""}, {"name": "cleanup-aws-loadbalancers", "description": "This app cleans up AWS ALB/ELB load balancers with no instances attached to them.", "version": "1.0.0", "language": "jinja2", "license": "Apache 2.0", "authors": ["someengineering"], "url": "https://resoto.com/", "categories": ["cleanup"], "default_config": {"min_age": "7d"}, "config_schema": [{"fqn": "cleanup_aws_loadbalancers", "bases": [], "properties": [{"name": "min_age", "kind": "string", "required": true, "description": "Age a load balancer must have before being considered for cleanup."}]}], "args_schema": null, "readme": "# cleanup-aws-loadbalancers\nAWS Loadbalancers Cleanup Resoto App\n\nThis app cleans up AWS ALB/ELB load balancers with no instances attached to them.\n\n## Usage\n\n```\ncleanup_aws_loadbalancers:\n  min_age: '7 days'\n```\n\nThe default load balancer age is 7 days. Meaning if a load balancer is more than 7 days old and does not have any instances/backends attached it will be flagged for cleanup.\n\nOptionally change the age cutoff value using the `min_age` option.\n\nExample of valid age units:\n\n```\nweeks\ndays\nhours\nminutes\n```\n\nEach of them can be abbreviated down to one letter. E.g. `7d`, `24h`, `60m`, etc. A space in between the numeric and the unit is optional, meaning `7d` and `7 days` are equivalent.\n", "icon": "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGNsYXNzPSJpY29uIGljb24tdGFibGVyIGljb24tdGFibGVyLWJhdCIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlPSJjdXJyZW50Q29sb3IiIGZpbGw9Im5vbmUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+CiAgPHBhdGggc3Ryb2tlPSJub25lIiBkPSJNMCAwaDI0djI0SDB6IiBmaWxsPSJub25lIi8+CiAgPHBhdGggZD0iTTE3IDE2Yy43NCAtMi4yODYgMi43NzggLTMuNzYyIDUgLTNjLS4xNzMgLTIuNTk1IC4xMyAtNS4zMTQgLTIgLTcuNWMtMS43MDggMi42NDggLTMuMzU4IDIuNTU3IC01IDIuNXYtNGwtMyAybC0zIC0ydjRjLTEuNjQyIC4wNTcgLTMuMjkyIC4xNDggLTUgLTIuNWMtMi4xMyAyLjE4NiAtMS44MjcgNC45MDUgLTIgNy41YzIuMjIyIC0uNzYyIDQuMjYgLjcxNCA1IDNjMi41OTMgMCAzLjg4OSAuOTUyIDUgNGMxLjExMSAtMy4wNDggMi40MDcgLTQgNSAtNHoiIC8+CiAgPHBhdGggZD0iTTkgOGEzIDMgMCAwIDAgNiAwIiAvPgo8L3N2Zz4KCgo=", "source_hash": "sha256:e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855", "source": ""}, {"name": "cleanup-aws-alarms", "description": "This plugin marks all orphaned AWS CloudWatch Instance Alarms for cleanup.", "version": "1.0.0", "language": "jinja2", "license": "Apache 2.0", "authors": ["someengineering"], "url": "https://resoto.com/", "categories": ["cleanup"], "default_config": {"clouds_and_accounts": {"aws": ["1234567", "567890"]}}, "config_schema": [{"fqn": "cleanup_aws_alarms", "bases": [], "properties": [{"name": "clouds_and_accounts", "kind": "dictionary[string, string[]]", "required": false, "description": "Clouds and accounts to cleanup AWS alarms in."}], "allow_unknown_props": false, "successor_kinds": null, "aggregate_root": true, "metadata": null}], "args_schema": null, "readme": "# cleanup-aws-alarms\nAWS Cloudwatch Alarms Cleanup Plugin for Resoto\n\nThis plugin marks all orphaned AWS CloudWatch Instance Alarms for cleanup.\n\nThe following resources are currently being marked for cleanup:\n- Instance Alarms\n\n## Usage\n\n```\ncleanup_aws_alarms:\n  # Dictionary of key cloud with list of account IDs for which the plugin should be active as value\n  clouds_and_accounts:\n    aws:\n      - '1234567'\n      - '567890'\n```\n", "icon": "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGNsYXNzPSJpY29uIGljb24tdGFibGVyIGljb24tdGFibGVyLWJhdCIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlPSJjdXJyZW50Q29sb3IiIGZpbGw9Im5vbmUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+CiAgPHBhdGggc3Ryb2tlPSJub25lIiBkPSJNMCAwaDI0djI0SDB6IiBmaWxsPSJub25lIi8+CiAgPHBhdGggZD0iTTE3IDE2Yy43NCAtMi4yODYgMi43NzggLTMuNzYyIDUgLTNjLS4xNzMgLTIuNTk1IC4xMyAtNS4zMTQgLTIgLTcuNWMtMS43MDggMi42NDggLTMuMzU4IDIuNTU3IC01IDIuNXYtNGwtMyAybC0zIC0ydjRjLTEuNjQyIC4wNTcgLTMuMjkyIC4xNDggLTUgLTIuNWMtMi4xMyAyLjE4NiAtMS44MjcgNC45MDUgLTIgNy41YzIuMjIyIC0uNzYyIDQuMjYgLjcxNCA1IDNjMi41OTMgMCAzLjg4OSAuOTUyIDUgNGMxLjExMSAtMy4wNDggMi40MDcgLTQgNSAtNHoiIC8+CiAgPHBhdGggZD0iTTkgOGEzIDMgMCAwIDAgNiAwIiAvPgo8L3N2Zz4KCgo=", "source_hash": "sha256:78e3d2cc26e9e4acc187448e7569805c55a045c44d78592d6db6fafb1eeb9a59", "source": "{%- for cloud, accounts in config[\"clouds_and_accounts\"].items() %}\n    {%- for account in accounts %}\nsearch is(aws_cloudwatch_alarm) and /ancestors.account.reported.id == \"{{account}}\" and /ancestors.cloud.reported.id == \"{{cloud}}\" and cloudwatch_dimensions[*].name = InstanceId with (empty, <-- is(aws_ec2_instance)) | clean \"Abandoned CloudWatch Instance Alarm\"\n    {%- endfor %}\n{%- endfor %}\n"}, {"name": "cleanup-untagged", "description": "This app deletes cloud resources that are missing mandatory tags after a certain amount of time has passed since their creation.", "version": "1.0.0", "language": "jinja2", "license": "Apache 2.0", "authors": ["someengineering"], "url": "https://resoto.com/", "categories": ["cleanup"], "default_config": {"default": {"age": "2h"}, "tags": ["owner", "expiration"], "kinds": ["aws_ec2_instance", "aws_ec2_volume", "aws_vpc", "aws_cloudformation_stack", "aws_elb", "aws_alb", "aws_alb_target_group", "aws_eks_cluster", "aws_eks_nodegroup", "example_instance", "example_network"], "accounts": {"aws": {"068564737731": {"name": "playground", "age": "7d"}, "575584959047": {"name": "eng-sre"}}}}, "config_schema": [{"fqn": "cleanup_untagged", "bases": [], "properties": [{"name": "default", "kind": "dictionary[string, string]", "required": false, "description": "Default age after which tags must exist."}, {"name": "tags", "kind": "string[]", "required": false, "description": "List of mandatory tags."}, {"name": "kinds", "kind": "string[]", "required": false, "description": "Kinds that should be checked for tags."}, {"name": "accounts", "kind": "dictionary[string, dictionary[string, dictionary[string, string]]]", "required": false, "description": "Accounts to run the app on."}], "allow_unknown_props": false, "successor_kinds": null, "aggregate_root": true, "metadata": null}], "args_schema": null, "readme": "# cleanup-untagged - Resoto Infrastructure App\nCleanup Untagged App for Resoto\n\nThis app deletes cloud resources that are missing mandatory tags after a certain amount of time has passed since their creation.\n\n## Usage\n\nIn `resh` execute\n\n```\n> config edit resoto.apps.cleanup_untagged\n```\n\n```\ndefault:\n  age: '2h'\ntags:\n  - 'owner'\n  - 'expiration'\nkinds:\n  - 'aws_ec2_instance'\n  - 'aws_ec2_volume'\n  - 'aws_vpc'\n  - 'aws_cloudformation_stack'\n  - 'aws_elb'\n  - 'aws_alb'\n  - 'aws_alb_target_group'\n  - 'aws_eks_cluster'\n  - 'aws_eks_nodegroup'\n  - 'example_instance'\n  - 'example_network'\naccounts:\n  aws:\n    068564737731:\n      name: 'playground'\n      age: '7d'\n    '575584959047':\n      name: 'eng-sre'\n  example:\n    Example Account:\n      name: 'Example Account'\n```\n\n### Config format\n\nThe config section consists of four sub-sections. `default`, `tags`, `classes` and `accounts`. The `default` section specifies the default `age` a resource must have before we enforce mandatory tags on it. For instance if `age` is set to `2h` this means that whatever mechanism creates a resource has two hours to add those mandatory tags.\n\nThe `tags` section is a list of tag names that MUST exist on every resource class specified in `classes`. The `classes` section is a list of resource class names for which tags specified in the `tags` list must exist.\n\nThe `accounts` section contains a dictionary with cloud IDs as keys (e.g. `aws`) and account IDs for which tags will be enforced as values (e.g. `068564737731`). Those in turn contain a `name` and optionally an `age` override.\n\nThe following age units are valid:\n\n```\nweeks\ndays\nhours\nminutes\n```\n\nEach of them can be abbreviated down to one letter. E.g. `7d`, `24h`, `60m`, etc. A space in between the numeric and the unit is optional, meaning `7d` and `7 days` are equivalent.\n", "icon": "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGNsYXNzPSJpY29uIGljb24tdGFibGVyIGljb24tdGFibGVyLWJhdCIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlPSJjdXJyZW50Q29sb3IiIGZpbGw9Im5vbmUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+CiAgPHBhdGggc3Ryb2tlPSJub25lIiBkPSJNMCAwaDI0djI0SDB6IiBmaWxsPSJub25lIi8+CiAgPHBhdGggZD0iTTE3IDE2Yy43NCAtMi4yODYgMi43NzggLTMuNzYyIDUgLTNjLS4xNzMgLTIuNTk1IC4xMyAtNS4zMTQgLTIgLTcuNWMtMS43MDggMi42NDggLTMuMzU4IDIuNTU3IC01IDIuNXYtNGwtMyAybC0zIC0ydjRjLTEuNjQyIC4wNTcgLTMuMjkyIC4xNDggLTUgLTIuNWMtMi4xMyAyLjE4NiAtMS44MjcgNC45MDUgLTIgNy41YzIuMjIyIC0uNzYyIDQuMjYgLjcxNCA1IDNjMi41OTMgMCAzLjg4OSAuOTUyIDUgNGMxLjExMSAtMy4wNDggMi40MDcgLTQgNSAtNHoiIC8+CiAgPHBhdGggZD0iTTkgOGEzIDMgMCAwIDAgNiAwIiAvPgo8L3N2Zz4KCgo=", "source_hash": "sha256:ccbb122e6d0b37ded2ef7da0469b796b64a0e22aac305af9c2eaa098c526d747", "source": "{%- set tags_part = 'not(has_key(tags, [\"' + '\", \"'.join(config[\"tags\"]) + '\"]))' %}\n{%- set kinds_part = 'is([\"' + '\", \"'.join(config[\"kinds\"]) + '\"])' %}\n{%- set account_parts = [] %}\n{%- set default_age = config[\"default\"][\"age\"]|default(\"2h\") %}\n{%- for cloud_id, account in config[\"accounts\"].items() %}\n    {%- for account_id, account_data in account.items() %}\n        {%- set age = account_data.get(\"age\", default_age) %}\n        {%- set account_part = '(/ancestors.cloud.reported.id == \"' ~ cloud_id ~ '\" and /ancestors.account.reported.id == \"' ~ account_id ~ '\" and age > ' ~ age ~ ')' %}\n        {%- do account_parts.append(account_part) %}\n    {%- endfor %}\n{%- endfor %}\n{%- set accounts_part = \"(\" + \" or \".join(account_parts) + \")\" %}\n{%- set exclusion_part = \"/metadata.protected == false and /metadata.phantom == false and /metadata.cleaned == false\" %}\n{%- set required_tags = \", \".join(config[\"tags\"]) %}\n{%- set reason = \"Missing one or more of required tags \" ~ required_tags ~ \" and age more than threshold\" %}\n{%- set cleanup_search = 'search ' ~ exclusion_part ~ ' and ' ~ kinds_part ~ ' and ' ~ tags_part ~ ' and ' ~ accounts_part ~ ' | clean \"' ~ reason ~ '\"' %}\n{{ cleanup_search }}\n"}]
